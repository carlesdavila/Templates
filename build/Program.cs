using static Bullseye.Targets;
using static SimpleExec.Command;

const string artifactsDir = "artifacts";
const string autogeneratedDir = "Generated_Code";

Target(Targets.CleanArtifactsOutput, () =>
{
    if (Directory.Exists(artifactsDir)) Directory.Delete(artifactsDir, true);
    if (Directory.Exists(autogeneratedDir)) Directory.Delete(autogeneratedDir, true);

});

Target(Targets.PackBullseyeBuild, DependsOn(Targets.CleanArtifactsOutput), async () =>
{
    await RunAsync("dotnet", $"pack BullseyeBuildPack.csproj -o {Directory.CreateDirectory(artifactsDir).FullName} --nologo");
});

Target(Targets.PackServiceApi, DependsOn(Targets.CleanArtifactsOutput), async () =>
{
    await RunAsync("dotnet", $"pack ServiceApiPack.csproj -o {Directory.CreateDirectory(artifactsDir).FullName} --nologo");
});

Target(Targets.Pack, DependsOn(Targets.PackServiceApi, Targets.PackBullseyeBuild));

Target(Targets.RunTests, DependsOn(Targets.Pack), async () =>
{
    // Uninstall BullseyeBuild.Template
    await RunAsync("dotnet", "new --uninstall BullseyeBuild.Template");

    // Install BullseyeBuild.Template
    await RunAsync("dotnet", $"new --install {Path.Combine(artifactsDir, "BullseyeBuild.Template*.nupkg")}");
    
    // Apply template to folder
    await RunAsync("dotnet", $"new bullseyebuild -o {autogeneratedDir}");
    
    // Dry run
    await RunAsync("dotnet", $"run --project {Path.Combine(autogeneratedDir,"build")} -- -n -N");
});

Target("default", DependsOn(Targets.RunTests));

await RunTargetsAndExitAsync(args);

internal static class Targets
{
    public const string CleanArtifactsOutput = "clean-artifacts-output";
    public const string PackServiceApi = "pack-serviceapi";
    public const string PackBullseyeBuild = "pack-bullseyebuild";
    public const string Pack = "pack";
    public const string RunTests = "run-tests";
}